name: 'Nuke'

on:
  schedule:
    - cron:  '0 9 * * 1'
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cleanup:
    name: 'Cleanup'
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Test
      run: echo ${{ secrets.oidc_role }}
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.oidc_role }}
        aws-region: us-west-2

    - name: Create Data File
      run: |
        echo '{"accounts":[${{ vars.TARGET_ACCOUNT }}],"blocked_account":"${{ vars.BLOCKED_ACCOUNT }}"}' >> data.json
        
    - name: Create Config
      uses: ajeffowens/jinja2-action@90dab3da2215932ea86d2875224f06bbd6798617
      with:
        template: config.yml.j2
        output_file: config.yml
        data_file: data.json
        data_format: json
          
    - name: Install Nuke
      run: |
        AWS_NUKE_VERSION=v2.17.0 sh -c 'wget -c https://github.com/rebuy-de/aws-nuke/releases/download/$AWS_NUKE_VERSION/aws-nuke-$AWS_NUKE_VERSION-linux-amd64.tar.gz -O - | sudo tar -xz && sudo mv aws-nuke-$AWS_NUKE_VERSION-linux-amd64 /usr/local/bin/aws-nuke'

    - name: Run Nuke
      run: |
        aws-nuke -c config.yml --force --force-sleep 5
